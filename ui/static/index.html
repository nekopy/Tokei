<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tokei</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="title">
        <div>
          <div class="app">Tokei</div>
          <div class="subtitle">Setup + validation + run</div>
        </div>
      </div>
      <nav>
        <button id="tab-run" class="tab">Dashboard</button>
        <button id="tab-setup" class="tab active">Setup</button>
        <button id="tab-sources" class="tab">Sources</button>
        <button id="tab-getting-started" class="tab">Getting started</button>
      </nav>
    </header>

    <main>
      <section id="panel-setup" class="panel active">
        <div class="grid">
          <div class="card">
            <h2>Setup wizard</h2>
            <div class="hint">Guided setup for first-time users. You can run it again any time.</div>
            <div class="row">
              <button id="wizard-open" class="btn primary" type="button">Open setup wizard</button>
              <div id="wizard-status" class="status"></div>
            </div>
          </div>

          <div class="card">
            <h2>Environment</h2>
            <div class="kv">
              <div class="k">App root</div>
              <div class="v"><code id="env-appRoot">...</code></div>
              <div class="k">User root</div>
              <div class="v"><code id="env-userRoot">...</code></div>
              <div class="k">Platform</div>
              <div class="v"><code id="env-platform">...</code></div>
              <div class="k">Node</div>
              <div class="v"><code id="env-node">...</code></div>
            </div>
          </div>

          <div class="card">
            <h2>Report settings</h2>
            <div class="subhead">Output folder</div>
            <div class="row">
              <input id="report-output-dir" class="input" type="text" placeholder="Leave blank to use the default folder" />
              <button id="report-output-browse" class="btn" type="button">Browse…</button>
              <button id="report-output-open" class="btn" type="button">Open</button>
            </div>
            <div class="hint">
              Default is your Pictures folder: <code>Pictures\\Tokei</code>. HTML reports are saved in an <code>HTML</code> subfolder.
            </div>

            <div class="row">
              <div style="flex: 1; min-width: 220px">
                <div class="subhead">Timezone</div>
                <input id="report-timezone" class="input" type="text" placeholder="local (recommended)" />
              </div>
              <div style="flex: 1; min-width: 220px">
                <div class="subhead">Theme</div>
                <select id="report-theme" class="input"></select>
              </div>
              <div style="display: flex; align-items: flex-end; gap: 10px">
                <button id="report-theme-samples" class="btn" type="button">Open theme samples</button>
              </div>
            </div>
            <div class="hint">
              Timezone: leave as <code>local</code> unless you know you need a specific IANA name (for example <code>America/New_York</code>).
            </div>

            <div class="row">
              <button id="report-save-config" class="btn primary" type="button">Save config.json</button>
              <div id="report-save-status" class="status"></div>
            </div>
          </div>

          <div class="card">
            <h2>Toggl token</h2>
            <div class="row">
              <input id="toggl-token" class="input" type="password" placeholder="Paste token" />
              <button id="toggl-reveal" class="btn">Show</button>
              <button id="toggl-save" class="btn">Save</button>
              <button id="toggl-advanced-toggle" class="btn">Advanced</button>
            </div>
            <div class="hint">Required for Toggl hours. Stored in <code>toggl-token.txt</code>. Leave empty to clear.</div>

            <div id="toggl-advanced" class="advanced" hidden>
              <button id="toggl-advanced-close" class="panel-close" type="button" title="Hide">-</button>
              <div class="row">
                <div class="hint">
                  Due to Toggl API/history limitations, Tokei effectively only pulls a recent window (by default the last <b>60 days</b>). If you've used Toggl for more than 60 days, it's highly recommended you enter a baseline lifetime time. Baseline should be lifetime immersion time up to <b>yesterday</b> (do not include today). Once set, you generally should not keep updating it unless you entered the wrong value or changed what you count as immersion.
                </div>
              </div>
              <div class="row">
                <input id="toggl-baseline-hms" class="input" type="text" placeholder="HH:MM:SS (e.g. 120:00:00)" />
                <button id="toggl-open-summary" class="btn">Open Toggl Summary</button>
                <button id="toggl-baseline-save" class="btn">Save config.json</button>
              </div>
              <details class="details">
                <summary>How to find your lifetime hours in Toggl</summary>
                <div class="hint">
                  1) Open Toggl Track <b>Reports &gt; Summary</b>: <code>https://track.toggl.com/reports/summary</code>
                </div>
                <div class="hint">
                  2) Set the date range:
                  <ul>
                    <li><b>Start</b>: the earliest day you started tracking immersion</li>
                    <li><b>End</b>: yesterday (do NOT include today)</li>
                  </ul>
                </div>
                <div class="hint">
                  3) Select your immersion project(s) (select all that apply) and confirm you're in the right workspace.
                </div>
                <div class="hint">
                  4) Copy the <b>Total</b> time shown at the top, then enter it here as <code>HH:MM:SS</code> (hours can exceed 24).
                </div>
              </details>
              <div id="toggl-baseline-status" class="status"></div>
            </div>

            <div id="toggl-status" class="status"></div>
          </div>

          <div class="card full">
            <h2>Anki snapshot rules</h2>
            <div class="row">
              <div style="flex: 1; min-width: 220px">
                <div class="subhead">Anki profile</div>
                <input id="anki-profile" class="input" type="text" placeholder="e.g. User 1" />
              </div>
              <div style="flex: 1; min-width: 220px">
                <div class="subhead">Detected profiles</div>
                <select id="anki-profile-select" class="input">
                  <option value="">(detect profiles)</option>
                </select>
              </div>
              <div style="display: flex; align-items: flex-end; gap: 10px">
                <button id="anki-profiles-refresh" class="btn" type="button">Detect</button>
              </div>
            </div>
            <div class="hint">
              Used to locate your Anki profile folder (where <code>collection.anki2</code> lives). Click Save after changing it.
            </div>

            <div class="row">
              <button id="anki-discover" class="btn">Discover decks/fields</button>
              <button id="anki-test-export" class="btn">Test export</button>
              <div id="anki-status" class="status"></div>
            </div>

            <div class="row">
              <label class="check">
                <input id="anki-enabled" type="checkbox" />
                Enable built-in Anki snapshot exporter
              </label>
              <label class="check">
                <input id="anki-nonblocking" type="checkbox" />
                Don’t block reports if Anki isn’t set up
              </label>
              <button id="anki-advanced-toggle" class="btn">Advanced</button>
            </div>
            <div class="hint">
              If you don’t use Anki, enable “Don’t block” so reports still run (Anki stats will show as 0).
            </div>
            <div id="anki-advanced" class="advanced" hidden>
              <button id="anki-advanced-close" class="panel-close" type="button" title="Hide">×</button>
              <div class="row">
                <div class="hint">
                  Output dir controls where Hashi-compatible exports are written. Leave as <code>hashi_exports</code> unless you know you need to change it.
                </div>
              </div>
              <div class="row">
                <input id="anki-output-dir" class="input" type="text" placeholder="output_dir (default hashi_exports)" />
              </div>
            </div>

            <div class="rules">
              <table id="rules-table">
                <thead>
                  <tr>
                    <th>Rule ID</th>
                    <th>Deck paths (comma-separated)</th>
                    <th>Target field</th>
                    <th>Note types (optional, comma-separated)</th>
                    <th>Subdecks</th>
                    <th>Mature days</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="rules-body"></tbody>
              </table>
              <div class="row">
                <button id="rule-add" class="btn">Add rule</button>
                <button id="config-save" class="btn primary">Save config.json</button>
                <button id="config-discard" class="btn">Discard changes</button>
              </div>
              <div id="config-status" class="status"></div>
            </div>

            <div id="anki-discovered" class="discovered" hidden>
              <button id="anki-discovered-close" class="panel-close" type="button" title="Hide">×</button>
              <div class="hint">
                Click a rule row to select it, then click items below to add them. Shift+click copies to clipboard.
              </div>
              <div class="discover-grid">
                <div>
                  <div class="subhead">Decks</div>
                  <div id="anki-decks" class="chips"></div>
                </div>
                <div>
                  <div class="subhead">Note types</div>
                  <div id="anki-notetypes" class="chips"></div>
                </div>
                <div>
                  <div class="subhead">Fields</div>
                  <div id="anki-fields" class="chips"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card full">
            <h2>Launch options</h2>
            <div class="row">
              <label class="check">
                <input id="launch-open-on-startup" type="checkbox" />
                Open Tokei on startup
              </label>
            </div>
            <div class="hint">Launches Tokei automatically when you log in (Windows).</div>

            <div class="row">
              <label class="check">
                <input id="launch-start-minimized" type="checkbox" />
                Start minimized to tray
              </label>
            </div>
            <div class="hint">Starts hidden with only a tray icon. Use the tray menu to open the dashboard.</div>

            <div class="row">
              <label class="check">
                <input id="launch-close-minimizes" type="checkbox" />
                Close minimizes to tray
              </label>
            </div>
            <div class="hint">Clicking the window close button hides Tokei instead of quitting. Use tray ▸ Quit to exit.</div>

            <div class="row">
              <button id="launch-save" class="btn primary">Save launch options</button>
              <div id="launch-status" class="status"></div>
            </div>
            <div class="hint">These settings are stored in <code>config.json</code> and take effect after you restart the app.</div>
          </div>

          <div class="card full">
            <h2>GSM live sessions (optional)</h2>
            <div class="hint">
              Click <b>Install GSM live sessions</b> to add <code>tokei_live_sync.py</code>. GSM typically has a single <code>plugins.py</code>, so if you already have one, use <b>Copy plugins.py shim</b> and paste it into your existing file (don't overwrite unless you intend to).
            </div>
            <div class="row">
              <button id="gsm-install" class="btn primary">Install GSM live sessions</button>
              <button id="gsm-copy" class="btn">Copy plugins.py shim</button>
              <button id="gsm-open-folder" class="btn">Open GSM folder</button>
              <div id="gsm-status" class="status"></div>
            </div>
            <div id="gsm-status-detail" class="hint"></div>
            <details class="details">
              <summary>Advanced</summary>
              <div class="row">
                <button id="gsm-copy-helper" class="btn">Copy tokei_live_sync.py</button>
                <button id="gsm-open-plugin" class="btn">Open plugins.py</button>
                <button id="gsm-open-helper" class="btn">Open tokei_live_sync.py</button>
              </div>
              <div class="hint">
                Install creates <code>tokei_live_sync.py</code>. You still need to add the shim to your existing <code>plugins.py</code> so GSM calls it.
              </div>
            </details>
          </div>

          <div class="card full">
            <h2>Validation</h2>
            <div class="row">
              <button id="python-test" class="btn">Check Python</button>
              <div id="python-status" class="status"></div>
            </div>
            <div class="row">
              <button id="puppeteer-test" class="btn">Test Puppeteer PNG</button>
              <div id="puppeteer-status" class="status"></div>
            </div>
            <div class="hint">Writes a small test HTML into <code>cache/</code> and a PNG into <code>output/</code>.</div>
          </div>
        </div>
      </section>

      <section id="panel-sources" class="panel">
        <div class="grid">
          <div class="card full">
            <h2>Sources</h2>
            <div class="hint">
              Enable/disable sources and jump to your tools. Disabled sources are excluded from report totals/sections.
            </div>
            <div class="row">
              <button id="sources-save" class="btn primary">Save sources</button>
              <div id="sources-status" class="status"></div>
            </div>
            <div class="hint">Writes changes to <code>config.json</code>.</div>
          </div>

          <div class="card full">
            <h2>Mokuro (manga)</h2>
            <div class="row">
              <label class="check">
                <input id="mokuro-enabled" type="checkbox" />
                Enabled
              </label>
              <button id="mokuro-open" class="btn">Open reader.mokuro.app</button>
              <div id="mokuro-status" class="status"></div>
            </div>
            <div class="row">
              <input id="mokuro-path" class="input" type="text" placeholder="Path to volume-data.json or mokuro-reader folder" />
              <button id="mokuro-browse-folder" class="btn">Choose folder…</button>
              <button id="mokuro-open-path" class="btn">Open folder</button>
            </div>
            <div class="hint">
              Recommended for new users: sync your Mokuro folder with Google Drive. After installing Google Drive, open your Drive on your PC (often <code>G:\\</code>), find your <code>mokuro-reader</code> folder, and select it here (or select <code>volume-data.json</code>).
            </div>
            <div class="hint">Uses your configured <code>mokuro.volume_data_path</code> when enabled.</div>
          </div>

          <div class="card full">
            <h2>Ttsu Reader (novels)</h2>
            <div class="row">
              <label class="check">
                <input id="ttsu-enabled" type="checkbox" />
                Enabled
              </label>
              <button id="ttsu-open" class="btn">Open reader.ttsu.app</button>
              <div id="ttsu-status" class="status"></div>
            </div>
            <div class="row">
              <input id="ttsu-path" class="input" type="text" placeholder="Path to ttu-reader-data folder" />
              <button id="ttsu-browse-folder" class="btn">Choose folder…</button>
              <button id="ttsu-open-path" class="btn">Open folder</button>
            </div>
            <div class="hint">
              Recommended for new users: sync your Ttsu exports with Google Drive. After installing Google Drive, open your Drive on your PC (often <code>G:\\</code>), find your <code>ttu-reader-data</code> folder, and select it here.
            </div>
            <div class="hint">Uses your configured <code>ttsu.data_dir</code> when enabled.</div>
          </div>

          <div class="card full">
            <h2>GameSentenceMiner (GSM)</h2>
            <div class="row">
              <label class="check">
                <input id="gsm-enabled" type="checkbox" />
                Enabled
              </label>
              <button id="gsm-launch" class="btn">Launch GSM</button>
              <button id="gsm-open-folder2" class="btn">Open GSM folder</button>
              <div id="gsm-launch-status" class="status"></div>
            </div>
            <div class="hint">
              Launch uses the default install path under <code>%LOCALAPPDATA%\\Programs\\gamesentenceminer</code>.
            </div>
          </div>

          <div class="card full">
            <h2>Known CSV</h2>
            <div class="row">
              <button id="known-import" class="btn primary">Import known.csv…</button>
              <button id="known-open-folder" class="btn">Open folder</button>
              <button id="known-open-file" class="btn">Open file</button>
              <div id="known-status" class="status"></div>
              <input id="known-file" type="file" accept=".csv,text/csv" hidden />
            </div>
            <div class="hint">
              Import copies your CSV into <code>data/known.csv</code> under your Tokei user root for Phase 2 ingestion.
            </div>
          </div>
        </div>
      </section>

      <section id="panel-run" class="panel">
        <div class="card">
          <h2>Sync + Report</h2>
          <div class="row">
            <button id="sync-now" class="btn">Sync</button>
            <select id="report-mode" class="input">
              <option value="overwrite">Overwrite today's report</option>
              <option value="new">Create a new report</option>
            </select>
            <label class="check">
              <input id="sync-before-report" type="checkbox" checked />
              Sync before report
            </label>
            <button id="generate-report" class="btn primary">Generate report</button>
          </div>
          <div class="row">
            <div id="sync-status" class="status"></div>
            <div id="report-status" class="status"></div>
          </div>
          <div class="row">
            <button id="open-output" class="btn">Open output folder</button>
            <button id="open-html" class="btn">Open latest HTML</button>
          </div>
          <pre id="run-output" class="mono"></pre>
        </div>

        <div class="card">
          <h2>At a glance</h2>
          <div id="glance" class="glance"></div>
          <details class="details">
            <summary>Raw latest sync snapshot</summary>
            <pre id="latest-sync-raw" class="mono"></pre>
          </details>
          <details class="details">
            <summary>Raw latest report stats</summary>
            <pre id="latest-stats" class="mono"></pre>
          </details>
        </div>
      </section>

      <section id="panel-logs" class="panel">
        <div class="grid">
          <div class="card">
            <h2>Runtime log</h2>
            <div class="row">
              <button id="logs-refresh" class="btn">Refresh</button>
            </div>
            <pre id="runtime-log" class="mono"></pre>
          </div>

          <div class="card">
            <h2>Getting started</h2>
            <div class="hint">
              Use Setup once, then you mostly live on the Run tab. The Runtime log is only for troubleshooting.
            </div>

            <div class="subhead">Prerequisites</div>
            <div class="hint">
              - Install Python and make sure <code>python --version</code> works (Anki snapshot/export uses Python).
            </div>
            <div class="hint">
              - Have an Anki profile on this machine (the exporter reads your profile <code>collection.anki2</code>).
            </div>
            <div class="hint">
              - PNG reports: Electron builds bundle Puppeteer + a browser. You can verify it with “Test Puppeteer PNG”.
            </div>

            <div class="subhead">Step 1: Toggl</div>
            <div class="hint">
              Paste your Toggl API token and click Save. Use Show/Hide to verify it.
            </div>
            <div class="hint">
              The token is stored in <code>toggl-token.txt</code> under <code>%APPDATA%\\Tokei</code>.
            </div>

            <div class="subhead">Step 2: Anki snapshot rules (retention + review totals)</div>
            <div class="hint">
              Enable “built-in Anki snapshot exporter”, then add one or more rules. Each rule defines which decks and note field Tokei uses for Anki stats.
            </div>
            <div class="hint">
              - Click a rule row to select it (highlighted).
            </div>
            <div class="hint">
              - Click “Discover decks/fields” to load lists, then click items to add them to the selected rule. Shift+click copies.
            </div>
            <div class="hint">
              - Deck paths use <code>Deck::Subdeck</code> format. Multiple decks and note types per rule are comma-separated.
            </div>
            <div class="hint">
              - Target field is the note field that contains what you’re tracking (for example <code>Expression</code>).
            </div>
            <div class="hint">
              When you’re done, click “Save config.json”. This writes <code>config.json</code> under <code>%APPDATA%\\Tokei</code>.
            </div>

            <div class="subhead">Step 3: Validate (recommended)</div>
            <div class="hint">
              Run these once to confirm your machine is ready:
              Check Python, Test export, and Test Puppeteer PNG.
            </div>

            <div class="subhead">Step 4: Run reports</div>
            <div class="hint">
              Go to the Run tab and click Run now.
              “Overwrite today’s report” updates today’s existing report; “Create a new report” makes a new numbered report.
            </div>
            <div class="hint">
              Use “Open output folder” / “Open latest HTML” to view results. If something fails, check the Runtime log and any WARNINGS.txt next to your report.
            </div>
            <details class="details">
              <summary>Advanced</summary>
              <div class="hint">
                - Anki output dir: defaults to <code>hashi_exports</code> (recommended). Change only if you know why.
              </div>
              <div class="hint">
                - GSM live sessions: optional. It exports “today session totals” to <code>%TOKEI_USER_ROOT%\\cache\\gsm_live.sqlite</code> while GSM is running.
              </div>
              <div class="hint">
                - If you installed both the CLI and Electron builds, both typically share <code>%APPDATA%\\Tokei</code> via <code>TOKEI_USER_ROOT</code>.
              </div>
              <div class="hint">
                - Optional Anki producer: you can install the Hashi Anki add-on instead, and then disable the built-in snapshot exporter.
              </div>
            </details>
          </div>
        </div>
      </section>

      <section id="panel-getting-started" class="panel">
        <div id="getting-started-grid" class="grid"></div>
      </section>
    </main>

    <div id="wizard-overlay" class="wizard-overlay" hidden aria-hidden="true">
      <div class="wizard" role="dialog" aria-modal="true" aria-labelledby="wizard-title">
        <div class="wizard-head">
          <div id="wizard-title" class="wizard-title">Setup wizard</div>
          <button id="wizard-close" class="btn" type="button">Close</button>
        </div>
        <div id="wizard-steps" class="wizard-steps"></div>
        <div id="wizard-body" class="wizard-body"></div>
        <div class="wizard-foot">
          <div id="wizard-error" class="status bad"></div>
          <div class="wizard-actions">
            <button id="wizard-back" class="btn" type="button">Back</button>
            <button id="wizard-next" class="btn primary" type="button">Next</button>
          </div>
        </div>
      </div>
    </div>

    <div id="wizard-exit-overlay" class="wizard-exit-overlay" hidden aria-hidden="true">
      <div class="wizard-exit" role="dialog" aria-modal="true" aria-labelledby="wizard-exit-title">
        <div class="wizard-exit-title" id="wizard-exit-title">Exit setup wizard?</div>
        <div class="wizard-exit-body">
          You haven’t finished setup yet. If you exit now, Tokei may not be able to sync or generate reports until setup is completed.
        </div>
        <div id="wizard-exit-error" class="status bad"></div>
        <div class="wizard-exit-actions">
          <button id="wizard-exit-save" class="btn primary" type="button">Save and exit</button>
          <button id="wizard-exit-nosave" class="btn" type="button">Exit without saving</button>
          <button id="wizard-exit-cancel" class="btn" type="button">Continue setup</button>
        </div>
      </div>
    </div>

    <script type="module" src="app.js"></script>
  </body>
</html>
