<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tokei</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <div class="title">
        <div class="app">Tokei</div>
        <div class="subtitle">Setup + validation + run</div>
      </div>
      <nav>
        <button id="tab-setup" class="tab active">Setup</button>
        <button id="tab-run" class="tab">Run</button>
        <button id="tab-logs" class="tab">Logs</button>
      </nav>
    </header>

    <main>
      <section id="panel-setup" class="panel active">
        <div class="grid">
          <div class="card">
            <h2>Environment</h2>
            <div class="kv">
              <div class="k">App root</div>
              <div class="v"><code id="env-appRoot">...</code></div>
              <div class="k">User root</div>
              <div class="v"><code id="env-userRoot">...</code></div>
              <div class="k">Platform</div>
              <div class="v"><code id="env-platform">...</code></div>
              <div class="k">Node</div>
              <div class="v"><code id="env-node">...</code></div>
            </div>
          </div>

          <div class="card">
            <h2>Toggl token</h2>
            <div class="row">
              <input id="toggl-token" class="input" type="password" placeholder="Paste token (optional)" />
              <button id="toggl-reveal" class="btn">Show</button>
              <button id="toggl-save" class="btn">Save</button>
            </div>
            <div class="hint">Stored in <code>toggl-token.txt</code>. Leave empty to clear.</div>
            <div id="toggl-status" class="status"></div>
          </div>

          <div class="card full">
            <h2>Anki snapshot rules</h2>
            <div class="row">
              <button id="anki-discover" class="btn">Discover decks/fields</button>
              <button id="anki-test-export" class="btn">Test export</button>
              <div id="anki-status" class="status"></div>
            </div>

            <div class="row">
              <label class="check">
                <input id="anki-enabled" type="checkbox" />
                Enable built-in Anki snapshot exporter
              </label>
              <button id="anki-advanced-toggle" class="btn">Advanced</button>
            </div>
            <div id="anki-advanced" class="advanced" hidden>
              <button id="anki-advanced-close" class="panel-close" type="button" title="Hide">×</button>
              <div class="row">
                <div class="hint">
                  Output dir controls where Hashi-compatible exports are written. Leave as <code>hashi_exports</code> unless you know you need to change it.
                </div>
              </div>
              <div class="row">
                <input id="anki-output-dir" class="input" type="text" placeholder="output_dir (default hashi_exports)" />
              </div>
            </div>

            <div class="rules">
              <table id="rules-table">
                <thead>
                  <tr>
                    <th>Rule ID</th>
                    <th>Deck paths (comma-separated)</th>
                    <th>Target field</th>
                    <th>Note types (optional, comma-separated)</th>
                    <th>Subdecks</th>
                    <th>Mature days</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="rules-body"></tbody>
              </table>
              <div class="row">
                <button id="rule-add" class="btn">Add rule</button>
                <button id="config-save" class="btn primary">Save config.json</button>
                <button id="config-discard" class="btn">Discard changes</button>
              </div>
              <div id="config-status" class="status"></div>
            </div>

            <div id="anki-discovered" class="discovered" hidden>
              <button id="anki-discovered-close" class="panel-close" type="button" title="Hide">×</button>
              <div class="hint">
                Click a rule row to select it, then click items below to add them. Shift+click copies to clipboard.
              </div>
              <div class="discover-grid">
                <div>
                  <div class="subhead">Decks</div>
                  <div id="anki-decks" class="chips"></div>
                </div>
                <div>
                  <div class="subhead">Note types</div>
                  <div id="anki-notetypes" class="chips"></div>
                </div>
                <div>
                  <div class="subhead">Fields</div>
                  <div id="anki-fields" class="chips"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card full">
            <h2>Sources: Reading section</h2>
            <div class="hint">
              Controls whether reading sources are included in the report’s Reading card. If all are disabled, the Reading card is hidden.
            </div>
            <div class="row">
              <label class="check">
                <input id="mokuro-enabled" type="checkbox" />
                Enable Mokuro (manga characters)
              </label>
              <label class="check">
                <input id="ttsu-enabled" type="checkbox" />
                Enable Ttsu Reader (novel characters)
              </label>
              <label class="check">
                <input id="gsm-enabled" type="checkbox" />
                Enable GSM (game characters)
              </label>
            </div>
            <div class="hint">
              These toggles do not affect GSM live sessions install; they only control inclusion in report totals/sections.
            </div>
          </div>

          <div class="card full">
            <h2>GSM live sessions (optional)</h2>
            <div class="hint">
              GSM typically has a single <code>plugins.py</code>. If you already have one, paste the Tokei plugin code into your existing file (don't overwrite unless you intend to).
            </div>
            <div class="row">
              <button id="gsm-install" class="btn primary">Install GSM live sessions</button>
              <button id="gsm-copy" class="btn">Copy plugins.py shim</button>
              <button id="gsm-open-folder" class="btn">Open GSM folder</button>
              <div id="gsm-status" class="status"></div>
            </div>
            <div id="gsm-status-detail" class="hint"></div>
            <details class="details">
              <summary>Advanced</summary>
              <div class="row">
                <button id="gsm-copy-helper" class="btn">Copy tokei_live_sync.py</button>
                <button id="gsm-open-plugin" class="btn">Open plugins.py</button>
                <button id="gsm-open-helper" class="btn">Open tokei_live_sync.py</button>
              </div>
              <div class="hint">
                Install creates <code>tokei_live_sync.py</code>. You still need to add the shim to your existing <code>plugins.py</code> so GSM calls it.
              </div>
            </details>
          </div>

          <div class="card full">
            <h2>Validation</h2>
            <div class="row">
              <button id="python-test" class="btn">Check Python</button>
              <div id="python-status" class="status"></div>
            </div>
            <div class="row">
              <button id="puppeteer-test" class="btn">Test Puppeteer PNG</button>
              <div id="puppeteer-status" class="status"></div>
            </div>
            <div class="hint">Writes a small test HTML into <code>cache/</code> and a PNG into <code>output/</code>.</div>
          </div>
        </div>
      </section>

      <section id="panel-run" class="panel">
        <div class="card">
          <h2>Sync + Report</h2>
          <div class="row">
            <button id="sync-now" class="btn">Sync</button>
            <select id="report-mode" class="input">
              <option value="overwrite">Overwrite today's report</option>
              <option value="new">Create a new report</option>
            </select>
            <label class="check">
              <input id="sync-before-report" type="checkbox" checked />
              Sync before report
            </label>
            <button id="generate-report" class="btn primary">Generate report</button>
          </div>
          <div class="row">
            <div id="sync-status" class="status"></div>
            <div id="report-status" class="status"></div>
          </div>
          <div class="row">
            <button id="open-output" class="btn">Open output folder</button>
            <button id="open-html" class="btn">Open latest HTML</button>
          </div>
          <pre id="run-output" class="mono"></pre>
        </div>

        <div class="card">
          <h2>At a glance</h2>
          <div id="glance" class="glance"></div>
          <details class="details">
            <summary>Raw latest sync snapshot</summary>
            <pre id="latest-sync-raw" class="mono"></pre>
          </details>
          <details class="details">
            <summary>Raw latest report stats</summary>
            <pre id="latest-stats" class="mono"></pre>
          </details>
        </div>
      </section>

      <section id="panel-logs" class="panel">
        <div class="grid">
          <div class="card">
            <h2>Runtime log</h2>
            <div class="row">
              <button id="logs-refresh" class="btn">Refresh</button>
            </div>
            <pre id="runtime-log" class="mono"></pre>
          </div>

          <div class="card">
            <h2>Getting started</h2>
            <div class="hint">
              Use Setup once, then you mostly live on the Run tab. The Runtime log is only for troubleshooting.
            </div>

            <div class="subhead">Prerequisites</div>
            <div class="hint">
              - Install Python and make sure <code>python --version</code> works (Anki snapshot/export uses Python).
            </div>
            <div class="hint">
              - Have an Anki profile on this machine (the exporter reads your profile <code>collection.anki2</code>).
            </div>
            <div class="hint">
              - PNG reports: Electron builds bundle Puppeteer + a browser. You can verify it with “Test Puppeteer PNG”.
            </div>

            <div class="subhead">Step 1: Toggl</div>
            <div class="hint">
              Paste your Toggl API token and click Save. Use Show/Hide to verify it.
            </div>
            <div class="hint">
              The token is stored in <code>toggl-token.txt</code> under <code>%APPDATA%\\Tokei</code>.
            </div>

            <div class="subhead">Step 2: Anki snapshot rules (retention + review totals)</div>
            <div class="hint">
              Enable “built-in Anki snapshot exporter”, then add one or more rules. Each rule defines which decks and note field Tokei uses for Anki stats.
            </div>
            <div class="hint">
              - Click a rule row to select it (highlighted).
            </div>
            <div class="hint">
              - Click “Discover decks/fields” to load lists, then click items to add them to the selected rule. Shift+click copies.
            </div>
            <div class="hint">
              - Deck paths use <code>Deck::Subdeck</code> format. Multiple decks and note types per rule are comma-separated.
            </div>
            <div class="hint">
              - Target field is the note field that contains what you’re tracking (for example <code>Expression</code>).
            </div>
            <div class="hint">
              When you’re done, click “Save config.json”. This writes <code>config.json</code> under <code>%APPDATA%\\Tokei</code>.
            </div>

            <div class="subhead">Step 3: Validate (recommended)</div>
            <div class="hint">
              Run these once to confirm your machine is ready:
              Check Python, Test export, and Test Puppeteer PNG.
            </div>

            <div class="subhead">Step 4: Run reports</div>
            <div class="hint">
              Go to the Run tab and click Run now.
              “Overwrite today’s report” updates today’s existing report; “Create a new report” makes a new numbered report.
            </div>
            <div class="hint">
              Use “Open output folder” / “Open latest HTML” to view results. If something fails, check the Runtime log and any WARNINGS.txt next to your report.
            </div>
            <details class="details">
              <summary>Advanced</summary>
              <div class="hint">
                - Anki output dir: defaults to <code>hashi_exports</code> (recommended). Change only if you know why.
              </div>
              <div class="hint">
                - GSM live sessions: optional. It exports “today session totals” to <code>%TOKEI_USER_ROOT%\\cache\\gsm_live.sqlite</code> while GSM is running.
              </div>
              <div class="hint">
                - If you installed both the CLI and Electron builds, both typically share <code>%APPDATA%\\Tokei</code> via <code>TOKEI_USER_ROOT</code>.
              </div>
              <div class="hint">
                - Optional Anki producer: you can install the Hashi Anki add-on instead, and then disable the built-in snapshot exporter.
              </div>
            </details>
          </div>
        </div>
      </section>
    </main>

    <script type="module" src="app.js"></script>
  </body>
</html>
